name: ğŸš€ CI Pipeline - Build, Lint & Test

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, ready_for_review]
  push:
    branches: [main]
  workflow_dispatch: # Allow manual triggering

# Optimize for cost: cancel previous runs on new commits
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# Set default permissions for security
permissions:
  contents: read
  pull-requests: write
  checks: write

env:
  NODE_VERSION: '22'
  # Cost optimization: disable telemetry
  NEXT_TELEMETRY_DISABLED: 1
  # CI environment flag
  CI: true

jobs:
  # ============================================================================
  # Pre-flight Checks - Fast feedback for common issues
  # ============================================================================
  preflight:
    name: ğŸ” Pre-flight Checks
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      should-skip: ${{ steps.skip-check.outputs.should-skip }}
      changed-files: ${{ steps.changes.outputs.changed-files }}

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: ğŸ”„ Check for Skip CI
        id: skip-check
        run: |
          if git log -1 --pretty=%B | grep -q "\[skip ci\]"; then
            echo "should-skip=true" >> $GITHUB_OUTPUT
            echo "ğŸš« Skipping CI due to [skip ci] in commit message"
          else
            echo "should-skip=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“Š Detect Changed Files
        id: changes
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            changed_files=$(git diff --name-only HEAD~1..HEAD | tr '\n' ' ')
          else
            changed_files=$(git diff --name-only HEAD~1..HEAD | tr '\n' ' ')
          fi
          echo "changed-files=$changed_files" >> $GITHUB_OUTPUT
          echo "ğŸ“ Changed files: $changed_files"

  # ============================================================================
  # Build & Dependencies - Cache-optimized installation
  # ============================================================================
  build:
    name: ğŸ—ï¸ Build & Dependencies
    runs-on: ubuntu-latest
    needs: preflight
    if: needs.preflight.outputs.should-skip != 'true'
    timeout-minutes: 10

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: |
          echo "ğŸ”§ Installing dependencies..."
          npm ci --prefer-offline --no-audit --no-fund
          echo "âœ… Dependencies installed successfully"

      - name: ğŸ“Š Dependencies Info
        run: |
          echo "ğŸ“‹ Dependency Summary:"
          echo "â€¢ Node.js version: $(node --version)"
          echo "â€¢ npm version: $(npm --version)"
          echo "â€¢ Package count: $(npm list --depth=0 2>/dev/null | grep -c "â”œ\|â””" || echo "0")"
          echo "â€¢ node_modules size: $(du -sh node_modules 2>/dev/null | cut -f1 || echo "N/A")"

      - name: ğŸ—ï¸ Build Application
        run: |
          echo "ğŸ”¨ Building Next.js application..."
          npm run build
          echo "âœ… Build completed successfully"

      - name: ğŸ“ˆ Build Stats
        run: |
          echo "ğŸ“Š Build Output Summary:"
          if [ -d ".next" ]; then
            echo "â€¢ .next directory size: $(du -sh .next | cut -f1)"
            echo "â€¢ Static files: $(find .next/static -type f 2>/dev/null | wc -l || echo "0")"
          fi

      - name: ğŸ’¾ Cache Build Output
        uses: actions/cache@v4
        with:
          path: |
            .next
            node_modules
          key: ${{ runner.os }}-build-${{ hashFiles('package-lock.json') }}-${{ hashFiles('**/*.ts', '**/*.tsx', '**/*.js', '**/*.jsx') }}
          restore-keys: |
            ${{ runner.os }}-build-${{ hashFiles('package-lock.json') }}-
            ${{ runner.os }}-build-

  # ============================================================================
  # Code Quality - Linting & Formatting
  # ============================================================================
  lint:
    name: ğŸ§¹ Code Quality & Linting
    runs-on: ubuntu-latest
    needs: [preflight, build]
    if: needs.preflight.outputs.should-skip != 'true'
    timeout-minutes: 8

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ’¾ Restore Cache
        uses: actions/cache@v4
        with:
          path: |
            .next
            node_modules
          key: ${{ runner.os }}-build-${{ hashFiles('package-lock.json') }}-${{ hashFiles('**/*.ts', '**/*.tsx', '**/*.js', '**/*.jsx') }}

      - name: ğŸ“¦ Install Dependencies (if needed)
        run: |
          if [ ! -d "node_modules" ]; then
            echo "ğŸ”§ Cache miss - installing dependencies..."
            npm ci --prefer-offline --no-audit --no-fund
          else
            echo "âœ… Using cached dependencies"
          fi

      - name: ğŸ§¹ Run ESLint
        run: |
          echo "ğŸ” Running ESLint analysis..."
          npm run lint 2>&1 | tee eslint-output.log
          echo "âœ… ESLint completed"

      - name: ğŸ“Š Lint Summary
        run: |
          echo "ğŸ“‹ Code Quality Summary:"
          total_files=$(find src -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.jsx" | wc -l)
          echo "â€¢ TypeScript/JavaScript files analyzed: $total_files"

          # Check for actual ESLint errors (not just the word "error")
          if grep -q "âœ–" eslint-output.log || grep -q "[0-9]\+ error" eslint-output.log; then
            errors=$(grep -c "âœ–\|[0-9]\+ error" eslint-output.log || echo "0")
            echo "â€¢ âŒ ESLint errors: $errors"
          else
            echo "â€¢ âœ… No ESLint errors found"
          fi

          # Check for actual ESLint warnings (not just the word "warning")
          if grep -q "âš \|[0-9]\+ warning" eslint-output.log; then
            warnings=$(grep -c "âš \|[0-9]\+ warning" eslint-output.log || echo "0")
            echo "â€¢ âš ï¸ ESLint warnings: $warnings"
          else
            echo "â€¢ âœ… No ESLint warnings found"
          fi

      - name: ğŸ”„ TypeScript Check
        run: |
          echo "ğŸ” Running TypeScript type checking..."
          npx tsc --noEmit --pretty
          echo "âœ… TypeScript check completed"

  # ============================================================================
  # Testing Suite - Comprehensive test execution
  # ============================================================================
  test:
    name: ğŸ§ª Test Suite
    runs-on: ubuntu-latest
    needs: [preflight, build]
    if: needs.preflight.outputs.should-skip != 'true'
    timeout-minutes: 12

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ’¾ Restore Cache
        uses: actions/cache@v4
        with:
          path: |
            .next
            node_modules
          key: ${{ runner.os }}-build-${{ hashFiles('package-lock.json') }}-${{ hashFiles('**/*.ts', '**/*.tsx', '**/*.js', '**/*.jsx') }}

      - name: ğŸ“¦ Install Dependencies (if needed)
        run: |
          if [ ! -d "node_modules" ]; then
            echo "ğŸ”§ Cache miss - installing dependencies..."
            npm ci --prefer-offline --no-audit --no-fund
          else
            echo "âœ… Using cached dependencies"
          fi

      - name: ğŸ§ª Run Test Suite
        run: |
          echo "ğŸš€ Starting comprehensive test suite..."
          echo "â±ï¸ Test started at: $(date)"

          # Run tests with coverage
          npm test -- --coverage --verbose --ci --watchAll=false --passWithNoTests

          echo "â±ï¸ Test completed at: $(date)"
          echo "âœ… Test suite execution completed"

      - name: ğŸ“Š Test Results Summary
        run: |
          echo "ğŸ“‹ Test Execution Summary:"

          # Count test files
          test_files=$(find __tests__ -name "*.test.ts" -o -name "*.test.tsx" -o -name "*.test.js" -o -name "*.test.jsx" 2>/dev/null | wc -l || echo "0")
          echo "â€¢ Test files executed: $test_files"

          # Coverage information (if coverage directory exists)
          if [ -d "coverage" ]; then
            echo "â€¢ Coverage report generated: âœ…"
            if [ -f "coverage/lcov.info" ]; then
              lines_covered=$(grep -c "^DA:" coverage/lcov.info || echo "N/A")
              echo "â€¢ Coverage data points: $lines_covered"
            fi
          fi

          echo "â€¢ Test environment: Node.js $(node --version)"
          echo "â€¢ Jest version: $(npx jest --version 2>/dev/null || echo "N/A")"

      - name: ğŸ“ˆ Upload Coverage Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 7

      - name: ğŸ’¬ Coverage Comment (PR only)
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            if (fs.existsSync('coverage/coverage-summary.json')) {
              const coverage = JSON.parse(fs.readFileSync('coverage/coverage-summary.json', 'utf8'));
              const total = coverage.total;
              
              const coverageComment = `## ğŸ“Š Test Coverage Report
              
              | Metric | Coverage | Status |
              |--------|----------|--------|
              | Lines | ${total.lines.pct}% | ${total.lines.pct >= 90 ? 'âœ…' : total.lines.pct >= 80 ? 'âš ï¸' : 'âŒ'} |
              | Functions | ${total.functions.pct}% | ${total.functions.pct >= 95 ? 'âœ…' : total.functions.pct >= 85 ? 'âš ï¸' : 'âŒ'} |
              | Branches | ${total.branches.pct}% | ${total.branches.pct >= 85 ? 'âœ…' : total.branches.pct >= 75 ? 'âš ï¸' : 'âŒ'} |
              | Statements | ${total.statements.pct}% | ${total.statements.pct >= 90 ? 'âœ…' : total.statements.pct >= 80 ? 'âš ï¸' : 'âŒ'} |
              
              **Target Coverage:** Lines â‰¥90%, Functions â‰¥95%, Branches â‰¥85%, Statements â‰¥90%
              `;
              
              // Find existing coverage comment
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
              });
              
              const existingComment = comments.find(comment => 
                comment.body.includes('ğŸ“Š Test Coverage Report')
              );
              
              if (existingComment) {
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: existingComment.id,
                  body: coverageComment
                });
              } else {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: coverageComment
                });
              }
            }

  # ============================================================================
  # Security & Dependencies Check
  # ============================================================================
  security:
    name: ğŸ”’ Security & Dependencies
    runs-on: ubuntu-latest
    needs: [preflight, build]
    if: needs.preflight.outputs.should-skip != 'true'
    timeout-minutes: 5

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ” Audit Dependencies
        run: |
          echo "ğŸ”’ Running security audit..."
          npm audit --audit-level=moderate --production
          echo "âœ… Security audit completed"

      - name: ğŸ“Š Security Summary
        run: |
          echo "ğŸ”’ Security & Dependencies Summary:"
          echo "â€¢ Production dependencies audit: âœ…"
          echo "â€¢ Audit level: moderate"
          echo "â€¢ Node.js version: $(node --version)"

  # ============================================================================
  # Final Status Report
  # ============================================================================
  ci-success:
    name: âœ… CI Pipeline Complete
    runs-on: ubuntu-latest
    needs: [preflight, build, lint, test, security]
    if: always() && needs.preflight.outputs.should-skip != 'true'
    timeout-minutes: 2

    steps:
      - name: ğŸ“Š Pipeline Summary
        run: |
          echo "ğŸš€ CI Pipeline Execution Summary"
          echo "=================================="
          echo "â€¢ Pre-flight: ${{ needs.preflight.result }}"
          echo "â€¢ Build: ${{ needs.build.result }}"
          echo "â€¢ Lint: ${{ needs.lint.result }}"
          echo "â€¢ Test: ${{ needs.test.result }}"
          echo "â€¢ Security: ${{ needs.security.result }}"
          echo "=================================="

          # Check if any job failed
          if [[ "${{ needs.build.result }}" != "success" || 
                "${{ needs.lint.result }}" != "success" || 
                "${{ needs.test.result }}" != "success" || 
                "${{ needs.security.result }}" != "success" ]]; then
            echo "âŒ Pipeline failed - check individual job results"
            exit 1
          else
            echo "âœ… All pipeline jobs completed successfully!"
          fi

      - name: ğŸ‰ Success Notification
        if: success()
        run: |
          echo "ğŸ‰ Congratulations! Your code is ready for merge!"
          echo "ğŸ“‹ All quality gates passed:"
          echo "   âœ… Build successful"
          echo "   âœ… Code quality checks passed"
          echo "   âœ… All tests passing"
          echo "   âœ… Security audit clean"

  # ============================================================================
  # Auto-assign reviewers for PRs (cost-free)
  # ============================================================================
  auto-assign:
    name: ğŸ‘¥ Auto-assign Reviewers
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'opened'
    timeout-minutes: 1

    steps:
      - name: ğŸ¯ Auto-assign based on files changed
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pull_number = context.issue.number;

            // Get files changed in the PR
            const { data: files } = await github.rest.pulls.listFiles({
              owner,
              repo,
              pull_number,
            });

            const changedFiles = files.map(file => file.filename);
            let reviewers = [];

            // Auto-assign based on file patterns
            if (changedFiles.some(file => file.includes('api/'))) {
              console.log('ğŸ”§ API changes detected');
            }
            if (changedFiles.some(file => file.includes('test') || file.includes('spec'))) {
              console.log('ğŸ§ª Test changes detected');
            }
            if (changedFiles.some(file => file.includes('.github/workflows'))) {
              console.log('ğŸš€ CI/CD changes detected');
            }

            console.log(`ğŸ“ Files changed: ${changedFiles.length}`);
            console.log(`ğŸ‘¥ Auto-assignment complete`);
